import pandas as pd
import matplotlib.pyplot as plt

# 1. Load the data generated by the C++ script
df = pd.read_csv('../experiments/build/risk_vs_lambda.csv')

# The target risk you specified in C++
target_alpha = 0.10  

# 2. Find the optimal lambda (the first point where risk drops below target)
valid_lambdas = df[df['risk'] <= target_alpha]
if not valid_lambdas.empty:
    optimal_row = valid_lambdas.iloc[0]
    optimal_lambda = optimal_row['lambda']
else:
    optimal_lambda = None
    print("Warning: Curve never drops below the target alpha.")

# 3. Create the plot
plt.figure(figsize=(10, 6))

# Plot the Risk curve
plt.plot(df['lambda'], df['risk'], color='blue', linewidth=1.5, label='Risk $R(\lambda)$')

# Plot the horizontal Target Risk line
plt.axhline(y=target_alpha, color='red', linestyle='--', linewidth=1.5, label=f'Target $\\alpha$ = {target_alpha}')

# Plot the vertical Optimal Lambda line and intersection dot
if optimal_lambda is not None:
    plt.axvline(x=optimal_lambda, color='green', linestyle='--', linewidth=1.5)
    plt.plot(optimal_lambda, target_alpha, 'go', markersize=8, label=f'Optimal $\lambda$ = {optimal_lambda:.4f}')

# Formatting
plt.title('Conformal Risk Control: Lambda vs Risk', fontsize=14)
plt.xlabel('Lambda ($\lambda$)', fontsize=12)
plt.ylabel('Risk $R(\lambda)$', fontsize=12)
plt.grid(True, alpha=0.3)
plt.xlim(0, df['lambda'].max())
plt.ylim(0, 1.0)
plt.legend(loc='upper right', fontsize=10)

# Save and display
plt.tight_layout()
plt.savefig('crc_lambda_optimization.png', dpi=300)
plt.show()